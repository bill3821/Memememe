<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>MEMECOIN SNIPER</title>
<script src="https://unpkg.com/@solana/web3.js@1.95.8/lib/index.iife.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#0a0a0f;--bg1:#0f0f18;--bg2:#111118;--bg3:#1a1a24;
  --border:#1e1e2e;--border2:#2e2e3e;
  --txt:#cccce0;--dim:#666;--hi:#fff;
  --green:#00e88a;--red:#ff5555;--yellow:#f0c040;
  --font:'SF Mono','Fira Code','Consolas',monospace;
}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--font);font-size:13px;overflow-x:hidden;}
input:focus,button:focus{outline:none;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:999;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.07) 2px,rgba(0,0,0,0.07) 4px);}
#app{display:flex;flex-direction:column;min-height:100vh;max-width:480px;margin:0 auto;}

/* HEADER */
.header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--bg1);border-bottom:1px solid var(--border);}
.logo{font-size:18px;font-weight:700;color:#fff;letter-spacing:2px;}
.logo-sub{font-size:9px;color:var(--dim);letter-spacing:2px;display:block;margin-top:1px;}
.header-status{font-size:11px;color:var(--dim);text-align:right;line-height:1.5;}
.header-status .bal{color:var(--green);font-weight:700;}

/* BANNERS */
.banner{padding:10px 16px;font-size:12px;border-bottom:1px solid var(--border);display:none;line-height:1.5;}
.banner.show{display:block;}
.banner-err{background:#2a1010;color:#ff6666;border-color:#3a1a1a;}
.banner-warn{background:#1f1a0a;color:var(--yellow);border-color:#3a3010;}

/* KEY SECTION */
.key-section{background:var(--bg1);border-bottom:1px solid var(--border);padding:14px 16px;}
.key-label{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
.key-row{display:flex;gap:8px;align-items:center;}
.key-input{flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:5px;color:#fff;padding:10px 12px;font-size:13px;font-family:var(--font);-webkit-text-security:disc;}
.key-input::placeholder{color:#444;}
.btn-key{background:var(--green);color:#0a0a0f;border:none;border-radius:5px;font-weight:700;font-size:12px;padding:10px 14px;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;}
.btn-key.loaded{background:var(--red);color:#fff;}
.key-hint{font-size:10px;color:#444;margin-top:6px;line-height:1.5;}
.rpc-label{font-size:10px;color:var(--dim);margin-top:10px;margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;}
.rpc-select{width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:5px;color:#fff;padding:8px 10px;font-size:12px;font-family:var(--font);-webkit-appearance:none;appearance:none;}
.rpc-custom{width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:5px;color:#fff;padding:8px 10px;font-size:12px;font-family:var(--font);margin-top:6px;}
.rpc-custom::placeholder{color:#444;}

/* CONTROLS */
.controls{padding:12px 16px;background:var(--bg1);border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:10px;}
.btn-main{border:none;border-radius:6px;font-weight:700;font-size:15px;padding:12px;cursor:pointer;font-family:var(--font);letter-spacing:1px;width:100%;transition:filter 0.15s;}
.btn-main:active{filter:brightness(0.82);}
.btn-start{background:var(--green);color:#0a0a0f;}
.btn-stop{background:var(--red);color:#fff;}
.btn-main:disabled{opacity:0.3;cursor:not-allowed;}
.stats-row{display:flex;gap:8px;}
.stat-box{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:8px 10px;}
.stat-label{font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;}
.stat-val{font-size:14px;font-weight:700;margin-top:2px;}
.tabs{display:flex;gap:4px;}
.tab{flex:1;background:transparent;border:1px solid var(--border2);color:var(--dim);border-radius:4px;padding:6px 4px;cursor:pointer;font-size:11px;font-family:var(--font);text-align:center;transition:all 0.15s;}
.tab.active{background:var(--bg2);color:#fff;border-color:var(--border2);}

/* PAGES */
.page{display:none;padding:12px 16px 40px;}
.page.active{display:block;}

/* PANEL */
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin-bottom:12px;overflow:hidden;}
.panel-head{padding:8px 12px;border-bottom:1px solid var(--border);font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;background:var(--bg1);}
.empty{padding:20px;text-align:center;color:#444;font-size:12px;}

/* POS CARD */
.pos-card{padding:10px 12px;border-bottom:1px solid var(--bg3);}
.pos-card:last-child{border-bottom:none;}
.pos-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;}
.pos-sym{font-weight:700;color:#fff;font-size:15px;}
.pos-badge{font-size:11px;font-weight:600;padding:2px 7px;border-radius:10px;}
.pos-bot{display:flex;gap:14px;flex-wrap:wrap;}
.pos-detail{font-size:11px;color:var(--dim);}

/* SCAN ROW */
.scan-row{display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid var(--bg3);gap:8px;}
.scan-row:last-child{border-bottom:none;}
.scan-sym{font-weight:600;color:var(--hi);flex:1;font-size:14px;}
.scan-spike{font-weight:700;font-size:13px;color:var(--yellow);}
.scan-liq{font-size:10px;color:var(--dim);}

/* SETTINGS */
.setting-row{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin-bottom:8px;}
.setting-label{color:#aaa;font-size:12px;flex:1;padding-right:10px;}
.setting-input{background:var(--bg3);border:1px solid var(--border2);border-radius:4px;color:#fff;padding:6px 8px;font-size:14px;width:90px;font-family:var(--font);text-align:right;}
.btn-sm{background:var(--bg3);color:#aaa;border:1px solid var(--border2);border-radius:4px;padding:5px 10px;cursor:pointer;font-size:11px;font-family:var(--font);}

/* LOG */
.log-panel{background:var(--bg);border:1px solid var(--border);border-radius:8px;overflow:hidden;display:flex;flex-direction:column;height:calc(100vh - 300px);min-height:220px;}
.log-head{display:flex;justify-content:space-between;align-items:center;padding:7px 12px;border-bottom:1px solid var(--border);background:var(--bg1);font-size:10px;color:var(--dim);}
.log-scroll{flex:1;overflow-y:auto;padding:4px 0;-webkit-overflow-scrolling:touch;}
.log-line{display:flex;gap:8px;padding:2px 12px;font-size:11px;line-height:1.7;}
.log-ts{color:#333;min-width:62px;flex-shrink:0;}
.log-info{color:#aaaacc;}
.log-success{color:var(--green);}
.log-error{color:var(--red);}
.log-warn{color:var(--yellow);}
</style>
</head>
<body>
<div id="app">

<div class="header">
  <div><span class="logo">âš¡ MEMECOIN</span><span class="logo-sub">SNIPER v1.1 ğŸ‹</span></div>
  <div class="header-status" id="headerStatus">No wallet loaded</div>
</div>

<div class="banner banner-err" id="errBanner"></div>
<div class="banner banner-warn show">âš ï¸ This bot trades real SOL. Only use a dedicated wallet with small funds you can afford to lose.</div>

<div class="key-section">
  <div class="key-label">Wallet Private Key</div>
  <div class="key-row">
    <input type="password" class="key-input" id="keyInput" placeholder="Paste your base58 private keyâ€¦"/>
    <button class="btn-key" id="btnKey" onclick="loadKey()">Load</button>
  </div>
  <div class="rpc-label">RPC Endpoint</div>
  <select class="rpc-select" id="rpcSelect" onchange="onRpcChange()">
    <option value="https://api.mainnet-beta.solana.com">Solana Public RPC (free, slower)</option>
  </select>
  <input type="text" class="rpc-custom" id="rpcCustom" placeholder="Or paste a Helius / QuickNode RPC URLâ€¦" oninput="onCustomRpc()"/>
  <div class="key-hint">ğŸ”’ Your key never leaves this device â€” it signs transactions locally in your browser.<br/>ğŸ’¡ For speed &amp; reliability, paste a free Helius RPC URL (sign up at helius.dev).</div>
</div>

<div class="controls">
  <button class="btn-main btn-start" id="btnBot" onclick="toggleBot()" disabled>â–¶  START BOT</button>
  <div class="stats-row">
    <div class="stat-box"><div class="stat-label">Open</div><div class="stat-val" id="statOpen" style="color:var(--yellow)">0</div></div>
    <div class="stat-box"><div class="stat-label">Closed</div><div class="stat-val" id="statClosed" style="color:#8888aa">0</div></div>
    <div class="stat-box"><div class="stat-label">PnL</div><div class="stat-val" id="statPnl" style="color:var(--green)">0.000000</div></div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š Dashboard</button>
    <button class="tab" onclick="switchTab('settings')">âš™ï¸ Settings</button>
    <button class="tab" onclick="switchTab('log')">ğŸ“‹ Log</button>
  </div>
</div>

<div class="page active" id="page-dashboard">
  <div class="panel"><div class="panel-head">Open Positions</div><div id="openList"><div class="empty">No open positions</div></div></div>
  <div class="panel"><div class="panel-head">Closed Trades</div><div id="closedList"><div class="empty">No closed trades yet</div></div></div>
  <div class="panel"><div class="panel-head">Last Scan â€” Top Surges</div><div id="scanList"><div class="empty">Waiting for first scanâ€¦</div></div></div>
</div>

<div class="page" id="page-settings">
  <div id="settingsContainer"></div>
  <button class="btn-sm" onclick="resetSettings()" style="width:100%;padding:10px;margin-top:4px;">â†º Reset to defaults</button>
</div>

<div class="page" id="page-log">
  <div class="log-panel">
    <div class="log-head"><span id="logCount">0 entries</span><button class="btn-sm" onclick="clearLog()">Clear</button></div>
    <div class="log-scroll" id="logScroll"></div>
  </div>
</div>

</div><!-- #app -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SOL_MINT  ="So11111111111111111111111111111111111111112";
const JUP_QUOTE ="https://public.jupiterapi.com/quote";
const JUP_SWAP  ="https://public.jupiterapi.com/swap";
const DEX_BOOSTS ="https://api.dexscreener.com/token-boosts/top/v1";
const DEX_PAIRS  ="https://api.dexscreener.com/token-pairs/v1/solana/";
const LAMPORTS  =1e9;

const DEFAULTS={buyAmountSol:0.05,takeProfitPct:3,maxHoldSecs:30,volumeSpikePct:200,maxLiquidityUsd:500000,minVolume5min:3000,maxConcurrent:2,slippageBps:200};
const SETTING_DEFS=[
  {key:"buyAmountSol",   label:"Buy Amount (SOL)",          step:0.01,  min:0.001},
  {key:"takeProfitPct",  label:"Take Profit (%)",          step:0.5,   min:0.5},
  {key:"maxHoldSecs",    label:"Max Hold (seconds)",       step:5,     min:10},
  {key:"volumeSpikePct", label:"Vol Spike Threshold (%)",  step:50,    min:50},
  {key:"maxLiquidityUsd",label:"Max Liquidity (USD)",      step:50000, min:10000},
  {key:"minVolume5min",  label:"Min 5min Volume (USD)",    step:500,   min:500},
  {key:"maxConcurrent",  label:"Max Open Positions",       step:1,     min:1},
  {key:"slippageBps",    label:"Slippage (basis points)",  step:50,    min:50},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let settings={...DEFAULTS}, keypair=null, pubkey=null;
let rpcUrl="https://api.mainnet-beta.solana.com", connection=null, balance=null;
let botRunning=false, stopFlag=false;
let positions=[], closed=[], seenTokens=new Set(), lastCands=[], logs=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ts(){return new Date().toLocaleTimeString([],{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function log(msg,type='info'){logs.unshift({ts:ts(),msg,type});if(logs.length>250)logs.length=250;renderLog();}
function renderLog(){
  const el=document.getElementById('logScroll');
  el.innerHTML=logs.length?logs.map(l=>`<div class="log-line"><span class="log-ts">${l.ts}</span><span class="log-${l.type}">${esc(l.msg)}</span></div>`).join(''):'<div class="empty">No logs yet.</div>';
  document.getElementById('logCount').textContent=logs.length+' entries';
}
function clearLog(){logs=[];renderLog();}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function showErr(msg){const b=document.getElementById('errBanner');b.textContent=msg;b.classList.add('show');setTimeout(()=>b.classList.remove('show'),5000);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BASE58 DECODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const B58='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
function bs58Decode(str){
  let r=[0];
  for(const c of str){
    const i=B58.indexOf(c);if(i<0)throw new Error('Bad base58 char: '+c);
    let carry=i;
    for(let j=0;j<r.length;j++){carry+=r[j]*58;r[j]=carry&0xff;carry>>=8;}
    while(carry>0){r.push(carry&0xff);carry>>=8;}
  }
  for(const c of str){if(c==='1')r.push(0);else break;}
  return new Uint8Array(r.reverse());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RPC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onRpcChange(){rpcUrl=document.getElementById('rpcSelect').value;document.getElementById('rpcCustom').value='';connection=new solanaWeb3.Connection(rpcUrl,'finalized');}
function onCustomRpc(){const v=document.getElementById('rpcCustom').value.trim();if(v){rpcUrl=v;connection=new solanaWeb3.Connection(rpcUrl,'finalized');}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD / CLEAR KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadKey(){
  if(keypair){
    keypair=null;pubkey=null;balance=null;connection=null;
    document.getElementById('keyInput').value='';
    document.getElementById('btnKey').textContent='Load';
    document.getElementById('btnKey').classList.remove('loaded');
    document.getElementById('headerStatus').innerHTML='No wallet loaded';
    document.getElementById('btnBot').disabled=true;
    log('Key cleared'); return;
  }
  const raw=document.getElementById('keyInput').value.trim();
  if(!raw){showErr('Paste your private key first');return;}
  try{
    keypair=solanaWeb3.Keypair.fromSecretKey(bs58Decode(raw));
    pubkey=keypair.publicKey.toString();
    rpcUrl=document.getElementById('rpcCustom').value.trim()||document.getElementById('rpcSelect').value;
    connection=new solanaWeb3.Connection(rpcUrl,'finalized');
    balance=await connection.getBalance(keypair.publicKey)/LAMPORTS;
    document.getElementById('btnKey').textContent='Clear';
    document.getElementById('btnKey').classList.add('loaded');
    document.getElementById('headerStatus').innerHTML=`<span class="bal">${balance.toFixed(4)} SOL</span><br/>${pubkey.slice(0,8)}â€¦${pubkey.slice(-4)}`;
    document.getElementById('btnBot').disabled=false;
    log(`Wallet loaded: ${pubkey.slice(0,8)}â€¦${pubkey.slice(-4)} | ${balance.toFixed(4)} SOL`,'success');
    if(balance<settings.buyAmountSol*1.5)log('âš ï¸ Low balance â€” fund this wallet before starting.','warn');
  }catch(e){keypair=null;pubkey=null;showErr('Invalid key: '+(e.message||e));}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGN & SEND â€” handles BOTH versioned and legacy transactions
// Jupiter returns versioned TXs (first byte >= 0x80) most of the time,
// but sometimes returns legacy TXs (first byte < 0x80).
// VersionedTransaction.deserialize() crashes on legacy â€” that's the
// "Load failed" error. We detect the type and route accordingly.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function signAndSend(base64Tx){
  const raw=Uint8Array.from(atob(base64Tx),c=>c.charCodeAt(0));
  const isVersioned=(raw[0]&0x80)!==0;
  log('TX type: '+(isVersioned?'versioned':'legacy')+' (first byte 0x'+raw[0].toString(16)+')');
  if(isVersioned){
    const vTx=solanaWeb3.VersionedTransaction.deserialize(raw);
    vTx.sign([keypair]);
    return await connection.sendRawTransaction(vTx.serialize(),{skipPreflight:false,preflightCommitment:'finalized'});
  } else {
    const tx=solanaWeb3.Transaction.from(raw);
    tx.sign(keypair);
    return await connection.sendRawTransaction(tx.serialize(),{skipPreflight:false,preflightCommitment:'finalized'});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCAN â€” whale-following strategy
// Looks for tokens with recent large buys (high 5min volume), low
// liquidity (<$500k), and strong price momentum (>5% up in 5min).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function scanForSurges(){
  try{
    // Step 1: get top boosted/trending Solana tokens as starting pool
    const br=await fetch(DEX_BOOSTS);
    if(!br.ok){log('DexScreener boosts '+br.status,'error');return[];}
    const boosts=await br.json();
    const mints=[];
    for(const b of(boosts||[])){
      if(b.chainId==='solana'&&b.tokenAddress&&!mints.includes(b.tokenAddress)){
        mints.push(b.tokenAddress);
        if(mints.length>=20)break; // expanded pool for better selection
      }
    }
    if(!mints.length){log('No Solana boosted tokens found','warn');return[];}
    log('Scanning '+mints.length+' trending tokens for whale activity');

    // Step 2: fetch pair data for each token
    const allPairs=[];
    for(const mint of mints){
      try{
        const r=await fetch(DEX_PAIRS+mint);
        if(r.ok){const d=await r.json();if(Array.isArray(d))allPairs.push(...d);}
      }catch{}
    }

    // Step 3: WHALE FILTERS â€” find recent large buys in low-liq pairs
    const out=[];
    for(const p of allPairs){
      try{
        const addr=p.baseToken?.address,sym=p.baseToken?.symbol;
        const liq=p.liquidity?.usd||0;
        const v5=p.volume?.m5||0;         // 5min volume (USD)
        const v1h=p.volume?.h1||0;        // 1hr volume (USD)
        const price=parseFloat(p.priceUsd||0);
        const priceChange5m=parseFloat(p.priceChange?.m5||0);
        const tx5Buys=p.txns?.m5?.buys||0;
        const tx5Sells=p.txns?.m5?.sells||0;
        const age=p.pairCreatedAt?(Date.now()-p.pairCreatedAt)/60000:null;

        // Skip if: already seen, no price, or failed basic checks
        if(seenTokens.has(addr)||price===0)continue;

        // Filter 1: LOW liquidity (<$500k) â€” we want to move the market
        if(liq>settings.maxLiquidityUsd)continue;
        if(liq<10000)continue; // but not TOO low (likely scam/rug)

        // Filter 2: RECENT large volume ($3k+ in last 5min)
        if(v5<settings.minVolume5min)continue;

        // Filter 3: VOLUME SPIKE (200%+ vs 1hr avg = whale just bought)
        const avg1h=v1h>0?v1h/12:0; // 1hr avg per 5min
        if(!avg1h)continue;
        const spike=((v5-avg1h)/avg1h)*100;
        if(spike<settings.volumeSpikePct)continue;

        // Filter 4: BUY PRESSURE (more buys than sells in last 5min)
        if(tx5Buys<2)continue;              // at least 2 buy TXs
        if(tx5Buys<=tx5Sells)continue;       // must have more buys than sells

        // Filter 5: PRICE MOMENTUM (up >5% in last 5min = whale buy worked)
        if(priceChange5m<5)continue;

        // Filter 6: AGE (not brand new, not ancient)
        if(age!==null&&(age<5||age>120))continue; // 5min to 2hr old

        out.push({
          mint:addr,
          symbol:sym,
          priceUsd:price,
          liquidity:liq,
          spikePct:spike,
          volume5min:v5,
          priceChange5m,
          buyCount:tx5Buys
        });
      }catch{}
    }

    // Sort by: highest 5min volume first (biggest whale activity)
    out.sort((a,b)=>b.volume5min-a.volume5min);
    return out;
  }catch(e){log('Scan error: '+e.message,'error');return[];}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JUPITER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getQuote(inM,outM,amt){
  const p=new URLSearchParams({inputMint:inM,outputMint:outM,amount:String(amt),slippageBps:String(settings.slippageBps),restrictIntermediateTokens:'true'});
  const r=await fetch(JUP_QUOTE+'?'+p);
  return r.ok?r.json():null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buyToken(c){
  const{mint,symbol,priceUsd,spikePct,liquidity,volume5min,priceChange5m,buyCount}=c;
  const amt=Math.floor(settings.buyAmountSol*LAMPORTS);
  log(`ğŸ“ˆ WHALE DETECTED: ${symbol} | $${priceUsd.toExponential(3)} | vol5m $${volume5min.toFixed(0)} | priceâ†‘${priceChange5m.toFixed(1)}% | ${buyCount} buys | liq $${liquidity.toFixed(0)}`);
  const q=await getQuote(SOL_MINT,mint,amt);
  if(!q){log('âœ— No quote for '+symbol,'error');return;}
  const outAmt=parseInt(q.outAmount||0);
  if(!outAmt){log('âœ— Zero output for '+symbol,'error');return;}
  const sr=await fetch(JUP_SWAP,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userPublicKey:pubkey,quoteResponse:q,prioritizationFeeLamports:'auto'})});
  if(!sr.ok){log('âœ— Jupiter swap '+sr.status,'error');return;}
  const swapResp=await sr.json();
  if(!swapResp.swapTransaction){log('âœ— No swapTransaction in response. Keys: '+Object.keys(swapResp).join(', '),'error');return;}
  let sig;
  try{sig=await signAndSend(swapResp.swapTransaction);}catch(e){log('âœ— Sign/send: '+(e.message||e),'error');return;}
  log('âœ“ Buy TX: '+sig.slice(0,44)+'â€¦','success');
  seenTokens.add(mint);
  positions.push({id:Date.now(),mint,symbol,entryPriceUsd:priceUsd,buyTime:Date.now(),amountLamports:amt,tokenAmount:outAmt});
  refreshBalance();renderDashboard();
  log(`âœ“ Holding ${outAmt} units of ${symbol}`,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sellToken(pos,reason){
  log(`ğŸ”„ Selling ${pos.symbol} | ${reason}`);
  const q=await getQuote(pos.mint,SOL_MINT,pos.tokenAmount);
  if(!q){log('âœ— No sell quote for '+pos.symbol+' â€” retry next cycle','error');return false;}
  const sr=await fetch(JUP_SWAP,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userPublicKey:pubkey,quoteResponse:q,prioritizationFeeLamports:'auto'})});
  if(!sr.ok){log('âœ— Sell swap '+sr.status,'error');return false;}
  const swapResp=await sr.json();
  if(!swapResp.swapTransaction){log('âœ— No sell swapTransaction. Keys: '+Object.keys(swapResp).join(', '),'error');return false;}
  let sig;
  try{sig=await signAndSend(swapResp.swapTransaction);}catch(e){log('âœ— Sell sign/send: '+(e.message||e),'error');return false;}
  const solRec=parseInt(q.outAmount||0);
  const pnlSol=(solRec-pos.amountLamports)/LAMPORTS;
  const pnlPct=(pnlSol/settings.buyAmountSol)*100;
  log('âœ“ Sell TX: '+sig.slice(0,44)+'â€¦','success');
  log(`âœ“ PnL: ${pnlSol>=0?'+':''}${pnlSol.toFixed(6)} SOL (${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%)`,pnlPct>=0?'success':'warn');
  closed.push({...pos,pnlSol,pnlPct,closedAt:Date.now()});
  positions=positions.filter(p=>p.id!==pos.id);
  refreshBalance();renderDashboard();updateStats();
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function monitorPositions(){
  for(const pos of[...positions]){
    if(stopFlag)return;
    const q=await getQuote(pos.mint,SOL_MINT,pos.tokenAmount);
    if(!q)continue;
    const cur=parseInt(q.outAmount||0)/LAMPORTS;
    const ent=pos.amountLamports/LAMPORTS;
    const pct=((cur-ent)/ent)*100;
    const elapsed=(Date.now()-pos.buyTime)/1000;
    log(`ğŸ‘€ ${pos.symbol} | ${pct>=0?'+':''}${pct.toFixed(2)}% | ${elapsed.toFixed(0)}s`);
    if(pct>=settings.takeProfitPct){await sellToken(pos,`take-profit (${pct.toFixed(2)}%)`);return;}
    if(elapsed>=settings.maxHoldSecs){await sellToken(pos,`timeout (${elapsed.toFixed(0)}s)`);return;}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOT LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function botLoop(){
  while(!stopFlag){
    try{
      if(positions.length)await monitorPositions();
      if(stopFlag)break;
      if(positions.length<settings.maxConcurrent){
        const surges=await scanForSurges();
        lastCands=surges;renderScanList();
        if(surges.length){log('ğŸ” '+surges.length+' surge candidate(s)');await buyToken(surges[0]);}
        else log('ğŸ” No surges this cycle.');
      }else log('â³ At max positions ('+settings.maxConcurrent+')');
    }catch(e){log('Loop error: '+(e.message||e),'error');}
    const end=Date.now()+5000;
    while(Date.now()<end&&!stopFlag){await sleep(2000);if(positions.length&&!stopFlag){try{await monitorPositions();}catch{}}}
  }
  botRunning=false;renderBotBtn();
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleBot(){
  if(botRunning){stopFlag=true;botRunning=false;log('â¹ Bot stopped');renderBotBtn();return;}
  if(!keypair){showErr('Load your private key first');return;}
  if(balance<settings.buyAmountSol*1.1){showErr('Insufficient balance');return;}
  stopFlag=false;botRunning=true;
  log('ğŸš€ Bot started â€” scanning every 5s, monitoring every 2s','success');
  renderBotBtn();botLoop();
}
function renderBotBtn(){
  const b=document.getElementById('btnBot');
  b.textContent=botRunning?'â¹  STOP BOT':'â–¶  START BOT';
  b.className='btn-main '+(botRunning?'btn-stop':'btn-start');
  b.disabled=!keypair;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BALANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshBalance(){
  if(!keypair||!connection)return;
  try{
    balance=await connection.getBalance(keypair.publicKey)/LAMPORTS;
    document.getElementById('headerStatus').innerHTML=`<span class="bal">${balance.toFixed(4)} SOL</span><br/>${pubkey.slice(0,8)}â€¦${pubkey.slice(-4)}`;
  }catch{}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){renderOpenList();renderClosedList();renderScanList();updateStats();}
function renderOpenList(){
  const el=document.getElementById('openList');
  if(!positions.length){el.innerHTML='<div class="empty">No open positions</div>';return;}
  el.innerHTML=positions.map(p=>{
    const s=((Date.now()-p.buyTime)/1000).toFixed(0);
    return`<div class="pos-card"><div class="pos-top"><span class="pos-sym">${esc(p.symbol)}</span><span class="pos-badge" style="background:rgba(240,192,64,0.15);color:var(--yellow)">${s}s</span></div><div class="pos-bot"><span class="pos-detail">Entry $${p.entryPriceUsd.toExponential(3)}</span><span class="pos-detail">${(p.amountLamports/LAMPORTS).toFixed(3)} SOL</span><span class="pos-detail" style="opacity:0.6">timeout in ${Math.max(0,settings.maxHoldSecs-s)}s</span></div></div>`;
  }).join('');
}
function renderClosedList(){
  const el=document.getElementById('closedList');
  if(!closed.length){el.innerHTML='<div class="empty">No closed trades yet</div>';return;}
  el.innerHTML=[...closed].reverse().map(t=>{
    const col=t.pnlPct>=0?'var(--green)':'var(--red)';
    const bg=t.pnlPct>=0?'rgba(0,232,138,0.12)':'rgba(255,85,85,0.12)';
    return`<div class="pos-card"><div class="pos-top"><span class="pos-sym">${esc(t.symbol)}</span><span class="pos-badge" style="background:${bg};color:${col}">${t.pnlPct>=0?'+':''}${t.pnlPct.toFixed(2)}%</span></div><div class="pos-bot"><span class="pos-detail">PnL: ${t.pnlSol>=0?'+':''}${t.pnlSol.toFixed(6)} SOL</span></div></div>`;
  }).join('');
}
function renderScanList(){
  const el=document.getElementById('scanList');
  if(!lastCands.length){el.innerHTML='<div class="empty">Waiting for scanâ€¦</div>';return;}
  el.innerHTML=lastCands.slice(0,6).map(c=>
    `<div class="scan-row"><span class="scan-sym">${esc(c.symbol)}</span><span class="scan-spike" style="color:var(--green)">â†‘${c.priceChange5m.toFixed(1)}%</span><span class="scan-liq" style="color:var(--yellow)">$${(c.volume5min/1000).toFixed(1)}k vol</span><span class="scan-liq">$${(c.liquidity/1000).toFixed(0)}k liq</span></div>`
  ).join('');
}
function updateStats(){
  document.getElementById('statOpen').textContent=positions.length;
  document.getElementById('statClosed').textContent=closed.length;
  const pnl=closed.reduce((s,t)=>s+t.pnlSol,0);
  const el=document.getElementById('statPnl');
  el.textContent=(pnl>=0?'+':'')+pnl.toFixed(6)+' SOL';
  el.style.color=pnl>=0?'var(--green)':'var(--red)';
}
setInterval(()=>{if(positions.length)renderOpenList();},1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  document.getElementById('settingsContainer').innerHTML=SETTING_DEFS.map(d=>`<div class="setting-row"><label class="setting-label">${d.label}</label><input type="number" class="setting-input" value="${settings[d.key]}" step="${d.step}" min="${d.min}" onchange="settings['${d.key}']=Math.max(${d.min},parseFloat(this.value)||${d.min})"/></div>`).join('');
}
function resetSettings(){settings={...DEFAULTS};renderSettings();log('Settings reset');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  [...document.querySelectorAll('.tab')].find(t=>t.textContent.toLowerCase().includes(name)).classList.add('active');
  if(name==='settings')renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){renderSettings();renderLog();log('Ready. Paste your private key and tap Load.');})();
</script>
</body>
</html>
